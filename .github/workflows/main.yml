name: Windows_RDP_Fixed
on: workflow_dispatch

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Liberar espaço no Disco C
        shell: pwsh
        run: |
          rm -Recurse -Force "C:\Microsoft\AndroidNDK" -ErrorAction SilentlyContinue
          rm -Recurse -Force "C:\Microsoft\AndroidSDK" -ErrorAction SilentlyContinue
          rm -Recurse -Force "C:\hostedtoolcache\windows\CodeQL" -ErrorAction SilentlyContinue
          Get-PSDrive C | Select-Object Size, Free

      - name: Baixar Ngrok via Chocolatey
        # Usar o Chocolatey (gerenciador de pacotes) é mais confiável que baixar o zip manual
        run: choco install ngrok -y

      - name: Autenticar Ngrok
        run: ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}

      - name: Configurar Usuário e Senha
        run: |
          net user runneradmin "SenhaForte789!" /add
          net localgroup administrators runneradmin /add

      - name: Ativar RDP
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -Value 1

      - name: Abrir Túnel e Mostrar IP
        shell: pwsh
        run: |
          # Inicia o ngrok em segundo plano
          Start-Process ngrok -ArgumentList "tcp 3389"
          Start-Sleep -Seconds 15
          # Busca o IP gerado
          $tunnels = Invoke-RestMethod -Uri http://localhost:4040/api/tunnels
          $address = $tunnels.tunnels.public_url
          Write-Host "------------------------------------------"
          Write-Host "CONECTE NO RDP USANDO ESTE ENDEREÇO:"
          Write-Host $address
          Write-Host "------------------------------------------"

      - name: Manter Ligada
        run: Start-Sleep -Seconds 21600
