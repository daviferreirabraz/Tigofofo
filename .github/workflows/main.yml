name: Windows Cloud PC - UE5 Stable Attempt

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Liberar Espaço em Disco (Crucial)
        shell: powershell
        run: |
          Write-Host "Limpando arquivos desnecessários para ganhar espaço..."
          # Remove SDKs pesados que o GitHub instala por padrão
          Remove-Item -Recurse -Force "C:\Microsoft\AndroidNDK" -ErrorAction SilentlyContinue
          Remove-Item -Recurse -Force "C:\Microsoft\AndroidSDK" -ErrorAction SilentlyContinue
          Remove-Item -Recurse -Force "C:\hostedtoolcache\windows\dotnet" -ErrorAction SilentlyContinue
          Write-Host "Limpeza concluída."

      - name: Instalar Tailscale
        shell: powershell
        run: |
          Invoke-WebRequest -Uri https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe -OutFile tailscale-setup.exe
          Start-Process -FilePath "tailscale-setup.exe" -ArgumentList "/quiet", "/norestart" -Wait

      - name: Conectar ao Tailscale
        shell: powershell
        env:
          TS_AUTHKEY: ${{ secrets.TS_AUTHKEY }}
        run: |
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=$env:TS_AUTHKEY --hostname="ue5-pc-corrigido" --unattended

      - name: Configurar Usuario e RDP
        shell: powershell
        run: |
          # Criando usuário admin novo
          $Password = ConvertTo-SecureString "SenhaUE5@2026" -AsPlainText -Force
          New-LocalUser "ue5admin" -Password $Password
          Add-LocalGroupMember -Group "Administrators" -Member "ue5admin"
          
          # Desativa NLA para não dar erro no Windows App
          $ts = Get-WmiObject -Class "Win32_TSGeneralSetting" -Namespace root\cimv2\terminalservices -Filter "TerminalName='RDP-Tcp'"
          $ts.SetUserAuthenticationRequired(0)
          
          # Desativa Firewall
          Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False

      - name: Instalar Epic Games Launcher
        shell: powershell
        run: |
          Write-Host "Instalando Epic Games Launcher via Winget..."
          # O --location ajuda a garantir onde será instalado
          winget install --id EpicGames.EpicGamesLauncher --silent --accept-package-agreements --accept-source-agreements

      - name: Mostrar IP Final
        shell: powershell
        run: |
          $ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
          Write-Host "-------------------------------------------"
          Write-Host "CONECTE PELO WINDOWS APP"
          Write-Host "IP: $ip"
          Write-Host "USUARIO: ue5admin"
          Write-Host "SENHA: SenhaUE5@2026"
          Write-Host "-------------------------------------------"
          Start-Sleep -Seconds 21600
