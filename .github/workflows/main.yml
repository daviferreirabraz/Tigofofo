name: Windows Cloud PC - 14GB (Windows App Ready)

on:
  workflow_dispatch:

jobs:
  build:
    name: Configurando PC de 14GB
    runs-on: windows-latest
    timeout-minutes: 360 # O GitHub Actions gratuito para após 6 horas (360 min)

    steps:
      - name: 1. Instalar Tailscale (Rede)
        shell: powershell
        run: |
          # Baixa e instala o Tailscale para gerar o IP de conexão
          $url = "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe"
          Invoke-WebRequest -Uri $url -OutFile "ts.exe"
          Start-Process -FilePath ".\ts.exe" -ArgumentList "/S" -Wait
          # Conecta usando sua chave (Certifique-se que ela é válida)
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTHKEY }} --accept-routes

      - name: 2. Configurar Usuário e RDP (Para Windows App)
        shell: powershell
        run: |
          # Define o usuário e a senha que você usará no celular
          $user = "runneradmin"
          $pass = "Suasenha123!"
          net user $user $pass /add
          net localgroup Administrators $user /add
          
          # Habilita a Área de Trabalho Remota (Protocolo do Windows App)
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          
          # Desativa NLA para facilitar a conexão mobile
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0

      - name: 3. Baixar Seus Essenciais (Dropbox)
        shell: powershell
        run: |
          # Baixa o seu arquivo .bat original
          Invoke-WebRequest -Uri "https://www.dropbox.com/scl/fi/7eiczvgil84czu55dxep3/Downloads.bat?rlkey=wzdc1wxjsph2b7r0atplmdz3p&dl=1" -OutFile "Downloads.bat"
          # Executa a instalação dos seus programas
          cmd /c Downloads.bat

      - name: 4. Manter PC Online
        shell: powershell
        run: |
          Write-Host "--- PC PRONTO PARA CONECTAR ---"
          Write-Host "Use o IP do Tailscale no Windows App"
          Write-Host "Usuário: runneradmin"
          Write-Host "Senha: Suasenha123!"
          # Mantém a VM viva
          while($true) { Start-Sleep -Seconds 60 }
