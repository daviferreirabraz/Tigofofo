name: Windows Download PC - 150GB Free
on: workflow_dispatch

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: 1. Limpeza Atômica (Liberar +150GB)
        shell: powershell
        run: |
          Write-Host "Iniciando limpeza pesada... Aguarde alguns minutos."
          # Remove Visual Studio (O maior vilão, ~50-70GB)
          Remove-Item -Recurse -Force "C:\Program Files\Microsoft Visual Studio" -ErrorAction SilentlyContinue
          Remove-Item -Recurse -Force "C:\Program Files (x86)\Microsoft Visual Studio" -ErrorAction SilentlyContinue
          
          # Remove Android SDK/NDK (~40GB)
          Remove-Item -Recurse -Force "C:\Microsoft\AndroidNDK" -ErrorAction SilentlyContinue
          Remove-Item -Recurse -Force "C:\Microsoft\AndroidSDK" -ErrorAction SilentlyContinue
          
          # Remove Caches e Ferramentas (~60GB)
          Remove-Item -Recurse -Force "C:\hostedtoolcache\windows" -ErrorAction SilentlyContinue
          Remove-Item -Recurse -Force "C:\Program Files\dotnet" -ErrorAction SilentlyContinue
          
          Write-Host "Espaço Livre Final:"
          $drive = Get-PSDrive C
          $freeGB = [math]::Round($drive.Free / 1GB, 2)
          Write-Host "$freeGB GB disponíveis."

      - name: 2. Instalar Tailscale
        shell: powershell
        run: |
          $url = "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe"
          Invoke-WebRequest -Uri $url -OutFile "ts.exe"
          Start-Process -FilePath ".\ts.exe" -ArgumentList "/S" -Wait
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTHKEY }} --accept-routes

      - name: 3. Configurar Windows App (RDP)
        shell: powershell
        run: |
          net user runneradmin Baixar100gb! /add
          net localgroup Administrators runneradmin /add
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

      - name: 4. Instalar Chrome e 7-Zip
        shell: powershell
        run: |
          Set-ExecutionPolicy Bypass -Scope Process -Force; iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
          choco install googlechrome 7zip -y

      - name: 5. Manter Ativo
        shell: powershell
        run: |
          while($true) { Start-Sleep -Seconds 60 }
